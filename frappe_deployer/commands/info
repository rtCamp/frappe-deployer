from typing import Annotated
from frappe_manager import CLI_BENCHES_DIRECTORY
from frappe_manager.logger.log import richprint
import typer


import subprocess
from typing import Annotated
from frappe_manager import CLI_BENCHES_DIRECTORY
from frappe_manager.logger.log import richprint
import typer
import toml

from frappe_deployer.commands import app

@app.command()
def info(
    ctx: typer.Context,
    site_name: Annotated[
        str,
        typer.Argument(help="The name of the site.", show_default=False, metavar="Site Name / Bench Name"),
    ],
):
    """
    Show release info for a site by inspecting each app's git repository.
    """
    richprint.start("working")

    bench_path = CLI_BENCHES_DIRECTORY / f"{site_name}/frappe-bench"
    apps_dir = bench_path / "apps"
    if not apps_dir.exists():
        richprint.exit(f"No apps directory found for site {site_name}")

    apps_list = []
    for app_dir in apps_dir.iterdir():
        if not app_dir.is_dir():
            continue
        git_dir = app_dir / ".git"
        if not git_dir.exists():
            continue

        def run_git(cmd):
            try:
                return subprocess.check_output(
                    ["git"] + cmd,
                    cwd=str(app_dir),
                    stderr=subprocess.DEVNULL
                ).decode().strip()
            except Exception:
                return None

        remote = run_git(["remote", "get-url", "origin"])
        branch = run_git(["rev-parse", "--abbrev-ref", "HEAD"])
        commit = run_git(["rev-parse", "HEAD"])

        app_dict = {
            "repo": remote if remote else app_dir.name,
            "ref": branch if branch else None,
            "app_name": app_dir.name,
            "shallow_clone": True,
            "subdir_path": None,
            "remote_name": "upstream",
            "fm_pre_build": None,
            "fm_post_build": None,
            "commit": commit if commit else None,
        }
        apps_list.append(app_dict)

    output_dict = {"apps": apps_list}
    print(toml.dumps(output_dict))
